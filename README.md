# KU-ONLINE Marketplace Frontend

This is a Next.js frontend project for the KU-ONLINE marketplace. It features a modern UI with mock data and is designed to work with any backend service.

## Tech Stack

- **Framework**: Next.js (with App Router)
- **UI Components**: ShadCN UI
- **Styling**: Tailwind CSS
- **Language**: TypeScript
- **Data**: Mock data for demonstration

## Supabase storage setup

Image uploads for product listings rely on a Supabase Storage bucket. The frontend defaults to a bucket named `product-images` (or the value of `NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET`). Create the bucket once in your Supabase project and keep it private:

1. Open the [Supabase dashboard](https://supabase.com/dashboard) for your project.
2. Navigate to **Storage → Buckets** and click **New bucket**.
3. Enter `product-images` as the name (or the bucket name you have configured in `NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET`).
4. Leave the bucket private. Uploads happen through the authenticated `/api/uploads` route and the UI retrieves signed URLs for previews.
5. (Optional) Set a file size limit and allowed MIME types that suit your marketplace.
6. Save the bucket and apply the policies in `supabase/storage-policies.sql` so only owners can manage their own images.

After the bucket exists, image uploads from the sell form will succeed. If uploads still fail, double-check the environment variables in `.env.local` for your Supabase URL, anon key, and storage bucket name.

## Supabase database & edge functions

Run the migrations and deploy the edge function so that the frontend can rely on live data instead of mocks:

1. `supabase db reset --env-file .env.local` (or `supabase db push`) to apply the schema, triggers, policies, and the demo seed data.
2. `supabase functions deploy product-search --project-ref <project-ref>` to publish the full-text search edge function. The
   frontend now relies on the function for both listings search and pagination metadata.
3. Verify the following environment variables exist in Vercel/Supabase: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, and `NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET`.

### Supabase Auth configuration

- In the Supabase dashboard (Authentication → URL configuration) set:
  - **Site URL** → `http://localhost:5000` for local runs and your production domain (for example `https://ku-online.vercel.app`) in hosted environments.
  - **Redirect URLs** → include `http://localhost:5000/*` for development. Avoid using `0.0.0.0` which browsers reject as an OAuth callback.
  - Add `https://<your-production-domain>/*` to Redirect URLs before shipping.
- Rotate the Google provider credentials if they were created for a different origin, then re-run the OAuth flow to confirm the user record is created with a populated profile.

### Operations quick reference

```
Local .env.local
  DATABASE_URL
  NEXT_PUBLIC_SUPABASE_URL
  NEXT_PUBLIC_SUPABASE_ANON_KEY
  SUPABASE_SERVICE_ROLE_KEY
  NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET=product-images
  NEXT_PUBLIC_SITE_URL=http://localhost:5000
  OPENAI_API_KEY=<openai-key-for-embeddings>
  ADMIN_REVALIDATE_TOKEN=<your-admin-revalidate-token>

Vercel (Dev/Preview/Prod)
  NEXT_PUBLIC_SUPABASE_URL
  NEXT_PUBLIC_SUPABASE_ANON_KEY
  SUPABASE_SERVICE_ROLE_KEY
  NEXT_PUBLIC_SUPABASE_STORAGE_BUCKET
  NEXT_PUBLIC_SITE_URL
  OPENAI_API_KEY
  ADMIN_REVALIDATE_TOKEN
```

- Purge caches after deploys: `ADMIN_REVALIDATE_TOKEN=... NEXT_PUBLIC_SITE_URL=https://ku-online.vercel.app node tools/revalidate.mjs categories`.
- Rotate Supabase keys via *Project Settings → API*, update `.env.local`, then `vercel env add <NAME> <environment>`.
- Maintain the `product-images` bucket with `node tools/storage-ensure.mjs`; audit RLS using `node tools/audit-supabase.mjs`. The bucket should remain private—reads happen via signed URLs generated by the backend.

### What the migration enables

- Marketplace tables: `users`, `categories`, `products`, `conversations`, `messages`, `reviews`, `favorites`, and `notifications`.
- RLS policies for buyers/sellers, along with helper RPCs like `get_or_create_conversation` and `search_products`.
- Automatic rating recalculation, conversation metadata updates, and message notifications via Postgres triggers.
- Generated `search_document` column and supporting indexes for fast filtering and fuzzy searches.

### Using the `product-search` edge function

The edge function wraps the `search_products` RPC for richer search results. Invoke it from the client with:

```ts
const { data, error } = await supabase.functions.invoke('product-search', {
  body: {
    query: 'iphone',
    categoryId: 'uuid',
    minPrice: 100000,
    maxPrice: 500000,
    city: 'Erbil',
    limit: 24,
    offset: 0,
  },
});
```

The response includes `{ items, limit, offset, totalCount }`, where `items` mirrors the `products` rows along with a `rank`
column for relevance scoring and `totalCount` reports how many listings match the query.

### Server-side search integration

- The homepage and `/products` route call a new `searchProducts` helper that invokes the edge function when a search query is
  provided, falling back to `getProducts` for empty queries.
- Pagination is preserved by forwarding the `limit`/`offset` values to the edge function and consuming the returned
  `totalCount`.
- Server-side normalization now hydrates seller/category relations for search results so UI components receive
  `ProductWithRelations` objects regardless of the data source.

### Smart recommendations

- The `20241205163000_add_product_embeddings.sql` migration enables the `vector` extension, adds a `products.embedding` column,
  and registers the `recommend_products` RPC that blends cosine similarity with category, price, and engagement filters.
- Deploy `supabase/functions/recommend-products` (via `supabase functions deploy recommend-products --project-ref <project-ref>`) so the backend can serve cached recommendations without exposing the service role key to the client.
- Populate embeddings with `node scripts/backfill-product-embeddings.mjs` (requires `OPENAI_API_KEY`, `NEXT_PUBLIC_SUPABASE_URL`,
  `SUPABASE_SERVICE_ROLE_KEY`). Re-run it whenever bulk imports happen or wire it into your ingestion pipeline.
- Once vectors exist, product pages automatically render the "Recommended for You" carousel powered by the new RPC. If no
  embeddings are available yet, the UI falls back to simple category-based suggestions.

### Smoke tests

Run `npm test` to compile the test bundle and execute smoke tests with Node's built-in runner. The tests stub the Supabase
server client and `product-search` edge response to validate the integration without requiring a live Supabase instance.

## Committing and pushing changes

If you are developing locally and want to publish updates to the default branch (commonly named `main`), run the following commands from the project root:

```bash
# review the staged files before committing
git status

# add the files you have modified
git add <file1> <file2>

# create a descriptive commit message
git commit -m "feat: summarize the change here"

# send your commit to the remote repository
git push origin main
```

Replace `<file1> <file2>` with the paths you modified and tailor the commit message to the work you completed. If your local branch name is not `main`, update the final `git push` command to match it (for example, `git push origin my-branch`).

## Features

- Modern, responsive marketplace UI
- Product browsing and filtering
- Category navigation
- Mobile-friendly design
- Dark/light theme support
- Mock data for demonstration purposes
